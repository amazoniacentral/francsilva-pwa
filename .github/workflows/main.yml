name: Build Bubblewrap App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Configuração do Java JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Instalação manual do Android SDK e Build Tools
    - name: Install Android SDK and Build Tools
      run: |
        sudo apt-get install -y wget unzip
        wget https://dl.google.com/android/repository/commandlinetools-linux-7302050_latest.zip -O tools.zip
        mkdir -p $HOME/android-sdk/cmdline-tools
        unzip tools.zip -d $HOME/android-sdk/cmdline-tools
        mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/android-sdk --licenses
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/android-sdk "platform-tools" "build-tools;30.0.3"

    - name: Add SDK to PATH
      run: |
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH
        echo "$HOME/android-sdk/build-tools/30.0.3" >> $GITHUB_PATH

    # Instalação do Bubblewrap
    - name: Install Bubblewrap
      run: |
        curl -sSL https://github.com/GoogleChromeLabs/bubblewrap/releases/download/v1.0.0/bubblewrap-1.0.0-linux-x64.tar.gz | tar -xz -C /usr/local/bin

    # Inicialização do Bubblewrap (Pulando instalação do SDK)
    - name: Initialize Bubblewrap (No SDK Install)
      run: |
        echo "No" | bubblewrap init --manifest https://api.gvendas.app.br/gvendas/site/3/manifest/?format=json --no-interactive --skip-sdk --jdk $JAVA_HOME

    # Construção do App com Bubblewrap
    - name: Build Bubblewrap App
      run: |
        bubblewrap build --keystore-path gvendas.keystore --key-password ${{ secrets.KEY_PASSWORD }} --key-alias gvendas

    # Geração do APK
    - name: Generate APK
      run: |
        bubblewrap build --keystore-path gvendas.keystore --key-password ${{ secrets.KEY_PASSWORD }} --key-alias gvendas --output-dir ./output

    # Upload do APK como artefato
    - name: Upload APK as an artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: ./output/*.apk
