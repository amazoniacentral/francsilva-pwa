name: Build Bubblewrap App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Checkout do repositório
    - name: Checkout repository
      uses: actions/checkout@v4

    # Instalação do Java JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Instalação automática do Android SDK
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    # Instalação do Bubblewrap via NPM
    - name: Install Bubblewrap
      run: |
        npm install -g @bubblewrap/cli

    # Inicialização do Bubblewrap com instalação automática do SDK
    - name: Initialize Bubblewrap
      run: |
        export JAVA_HOME=$(echo $JAVA_HOME)
        echo "Usando JAVA_HOME: $JAVA_HOME"
        yes | bubblewrap init --manifest https://api.gvendas.app.br/gvendas/site/3/manifest/?format=json --no-interactive --jdk $JAVA_HOME --verbose

    # Construção do App com Bubblewrap
    - name: Build Bubblewrap App
      run: |
        bubblewrap build --keystore-path gvendas.keystore --key-password ${{ secrets.KEY_PASSWORD }} --key-alias gvendas

    # Geração do APK
    - name: Generate APK
      run: |
        bubblewrap build --keystore-path gvendas.keystore --key-password ${{ secrets.KEY_PASSWORD }} --key-alias gvendas --output-dir ./output

    # Upload do APK como artefato
    - name: Upload APK as an artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: ./output/*.apk
